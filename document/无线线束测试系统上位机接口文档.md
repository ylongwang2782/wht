# 协议概念
1. 通信双方：嵌入式网关 <-> 上位机
2. 通信介质：以太网

# JSON
+ 数据类型：字符串
+ JSON 数据需压缩后发送
+ 指令类型 (`instruction` / `inst`)

| 值 | 含义 | 描述 |
| --- | --- | --- |
| 0 | Device Config | 设备配置指令 |
| 1 | Device Mode | 模式选择指令 |
| 2 | Device Unlock | 设备解锁指令 |
| 3 | Device Control | 设备控制指令 |
| 4 | Device Query | 设备查询指令 |


### 设备配置指令
#### 字段说明
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| inst(instruction) | int | 指令类型 |
| params(config) | array | 配置列表，每个元素代表一个设备 |
| params.id | string | 设备唯一 ID，格式为 16 进制字符串，以 `-` 分隔 |
| params.cond(Conduction Num) | int | 导通检测数量 |
| params.Z(Impedence Num) | int | 是否启用阻值检测，不配置或配置为 0 为不启用，1 为启用 |
| params.clip(Clip Num) | int | 是否启用卡钉检测，不配置或配置为 0 为不启用，数字为启用的卡钉板数量 |


#### 指令格式
```json
{
  "inst": 0,
  "params": [{
    "id": "37-32-48-5B",
    "cond": 10,
    "Z":5,
    "clip": 2
  },
    {
      "id": "37-32-4A-13",
      "cond": 6,
    }]
}
```

+ 指令类型 (`inst`): `0` 表示设备配置指令
+ 设备 1:
    - 设备 ID (`id`): `37-32-48-5B`
    - 导通检测数量 (`cond`): `10` 
    - 阻值检测 (`Z`): 启用，检测数量为 `5`
    - 卡钉检测 (`clip`): 启用，检测数量为 `4` 
+ 设备 2:
    - 设备 ID (`id`): `37-32-4A-13`
    - 导通检测数量 (`cond`): `6` 
    - 阻值检测 (`Z`): 不启用
    - 卡钉检测 (`clip`): 不启用

#### 指令回复
1. 配置成功

```json
{
  "status": 0,
  "result": {
    "inst": 0
  }
}
```

+ 状态码 (`status`): `0` 表示请求或操作成功。
+ 数据 (`result`):
    - 指令类型 (`inst`): `0` 表示设备配置指令
2. 配置失败

```json
{
  "status": 1,
  "result": {
    "inst": 0,
    "id": ["37-32-48-5B", "37-32-4A-13"]
  }
}
```

+ 状态码 (`status`): `1` 表示操作失败
+ 数据 (`result`):
    - 指令类型 (`inst`): `0` 表示设备配置指令
    - 设备 ID (`id`): 设备信息，包含未成功配置的设备 ID

### 模式选择指令
#### 字段说明
| 字段名称 | 类型 | 说明 | 取值及含义 |
| --- | --- | --- | --- |
| `inst` | `int` | 指令类型，用于指定当前操作的指令。 | 具体指令类型 |
| `mode` | `int` | 模式选择，用于指定当前操作的测试模式。 | 0: Conduction Test（导通检测）   1: Impedence Test（阻值检测）   2: Clip Test（卡钉检测） |


#### 指令格式
```json
{
  "inst": 1,
  "mode": 0
}
```

+ 指令类型 (`inst`): `1` 表示模式选择指令
+ 设备模式 (`mode`): `0`表示当前配置位导通检测模式

#### 指令回复
```json
{
  "status":0,
  "result": {
    "inst": 1,
    "mode": 0
  }
}
```

+ 状态码 (`status`): `0` 表示操作成功
+ 数据 (`result`):
    - 指令类型 (`inst`): `0` 表示模式选择指令
    - 设备模式 (`mode`): `0` 当前工作模式

### 设备解锁指令
#### 字段说明
| 变量名称 | 数据类型 | 说明 |
| --- | --- | --- |
| inst | string | 配置指令类型 |
| id | object | 设备信息，包含需要解锁的设备 ID<br/>*代表全设备 |


#### 指令格式
1. 系统中全设备解锁

```json
{
  "inst": 2,
  "id": ["*"]
}
```

+ 指令类型 (`inst`): `2` 表示设备解锁指令
+ 设备模式 (`id`): `"*"`字符串表示全有效
2. 指定设备列表解锁

```json
{
  "inst": 2,
  "id": ["37-32-48-5B", "37-32-4A-13"]
}
```

+ 指令类型 (`inst`): `2` 表示设备解锁指令
+ 设备模式 (`id`): `"37-32-48-5B", "37-32-4A-13"`表示指定生效设备

#### 指令回复
1. 配置成功

```json
{
  "status": 0,
  "result": {
    "inst": 2
  }
}
```

+ 状态码 (`status`): `0` 表示操作成功
+ 数据 (`data`):
    - 指令类型 (`inst`): `2` 表示模式选择指令
2. 配置失败

```json
{
  "status": 1,
  "result": {
    "inst": 2,
    "id": ["37-32-48-5B", "37-32-4A-13"]
  }
}
```

+ 状态码 (`status`): `1` 表示操作失败
+ 数据 (`result`):
    - 指令类型 (`inst`): `2` 表示设备解锁指令
    - 设备 ID (`id`): 设备信息，包含未成功解锁的设备 ID

### 设备控制指令
#### 字段说明
| 字段 | 类型 | 说明 |
| --- | --- | --- |
| inst(instruction) | int | 指令类型 |
| ctrl | int | 设备运行状态控制 |


#### 指令格式
```json
{
  "inst": 3,
  "ctrl": 0
}
```

+ 指令类型 (`inst`): `3` 表示设备控制指令
+ 设备模式 (`ctrl`): `0`表示停止

#### 指令回复
```json
{
  "status":0,
  "result": {
    "inst": 3,
    "ctrl": 0
  }
}
```

+ 状态码 (`status`): `0` 表示操作成功
+ 数据 (`result`):
    - 指令类型 (`inst`): `3` 表示设备控制指令
    - 设备控制 (`ctrl`): `0` 表示当前设备状态为停止

### 设备查询指令
查询单个或者多个设备的信息

#### 字段说明
#### 指令格式
1. 查询系统中的所有设备-外接卡钉板数量

```json
{
  "inst": 4,
  "id": ["*"],
  "params": {
    "query_clip": 1
  }
}
```

+ 指令类型 (`inst`): `4` 表示设备查询指令
+ 设备模式 (`id`): `"*"`字符串表示全设备有效
+ 参数(`params`): 
    - 查询卡钉板(`gpio_range`): `1` 查询有效
2. 查询系统中的所有设备，所有外设

```json
{
  "inst": 4,
  "id": ["*"],
  "params": {
    "gpio_range": 1
    "res_range": [0, 2],
    "query_clip": 1
  }
}
```

+ 指令类型 (`inst`): `4` 表示设备查询指令
+ 设备模式 (`id`): `"*"`字符串表示全设备有效
+ 参数(`params`): 
    - GPIO 范围(`gpio_range`): `1` 查询有效
    - 阻值范围(`res_range`): `[0, 2]` 需要查询阻值的引脚范围
    - 查询卡钉板(`gpio_range`): `1` 查询有效
3. 查询指定设备-指定外设

```json
{
  "inst": 4,
  "id": ["37-32-48-5B", "37-32-4A-13"]
  "params": {
    "gpio_range": 1
    "res_range": [0, 2],
  }
}
```

+ 指令类型 (`inst`): `4` 表示设备解锁指令
+ 设备模式 (`id`): `"37-32-48-5B", "37-32-4A-13"`表示指定生效设备
+ 参数(`params`): 
    - GPIO 范围(`gpio_range`): `1` 查询有效
    - 阻值范围(`res_range`): `[0, 2]` 需要查询阻值的引脚范围

#### 指令回复
1. 查询成功

```json
{
  "status": 0,
  "result": {
    "inst": 4,
    "params": [
      {
        "id": "37-32-48-5B",
        "clip_count": 1
      },
      {
        "id": "37-32-48-55",
        "clip_count": 2
      }
    ]
  }
}
```

+ 状态码 (`status`): `0` 表示操作成功
+ 数据 (`result`):
    - 数据 (`data`):
        * 指令类型 (`inst`): `4` 表示设备查询指令
        * 参数 (`params`): 返回的查询值
            + 设备 ID (`id`): `"37-32-48-5B"`表示回复设备 ID
            + 卡钉板数量(`clip_count`)：`1`表示卡钉板数量为 1

> 为了高效传输 62 个 GPIO 的电平状态，采用 紧凑的十六进制字符串 表示方式。每个 GPIO 的电平状态（`0` 或 `1`）被压缩为一个二进制位，最终将整个状态编码为一个十六进制字符串。(卡钉电平同理)
>
> `gpio_levels`解释：
>
> + 字段名称: `gpio_levels`
> + 类型: `string`
> + 格式: 十六进制字符串，例如 `"DEADBEEF"`。
> + 说明:
>     - 每个字符表示 4 个 GPIO 的状态（因为一个十六进制字符可以表示 4 位二进制数据）。
>     - 62 个 GPIO 需要 16 个十六进制字符（64 位）表示，剩余的 2 位填充为 `0`。
> 1. 二进制位映射：
>     - 每个 GPIO 的电平状态（`0` 或 `1`）映射为一个二进制位。
>     - 例如：
>         * GPIO 0 的状态为 `1` → 二进制位 `1`
>         * GPIO 1 的状态为 `0` → 二进制位 `0`
>         * GPIO 2 的状态为 `1` → 二进制位 `1`
>         * 以此类推。
> 2. 二进制转十六进制：
>     - 每 4 个二进制位转换为一个十六进制字符。
>     - 例如：
>         * 二进制 `1101` → 十六进制 `D`
>         * 二进制 `1010` → 十六进制 `A`
> 3. 填充：
>     - 62 个 GPIO 需要 64 位（8 字节）表示，剩余的 2 位填充为 `0`。
>
> #### 编码过程：
> 将 62 个 GPIO 状态转换为二进制位：
>
> 1. 1 0 1 0 ... 1 0
>
> 每 4 位转换为一个十六进制字符：
>
> 2. 1010 1101 1010 1101 ... 1010 1101
>
> 最终得到十六进制字符串：
>
> 3. "DEADBEEFDEADBEEF"
>

2. 全参数回复

```json
{
  "status": 0,
  "result": {
    "inst": 4,
    "params": [{
      "id": "37-32-48-5B",
      "gpio_levels": "00000000000000000000",
      "res_values": [120, 120, 0, 0],
      "clip_count": 1
    },
      {
        "id": "37-32-48-55",
        "gpio_levels": "10000000000000000000",
        "res_values": [120,  0],
        "clip_count": 2
      }]
  }
}
```

+ 状态码 (`status`): `0` 表示操作成功
+ 数据 (`result`):
    - 数据 (`data`):
        * 指令类型 (`inst`): `4` 表示设备查询指令
        * 参数 (`params`): 返回的查询值
            + 设备 ID (`id`): `"37-32-48-5B"`表示回复设备 ID
            + 引脚电平(`gpio_levels`)：`"00000000000000000000"`表示引脚输入全为低电平
            + 阻值(`res_values`)：`[120, 120, 0, 0]`表示阻值分别为 120,120,0,0 Ω
            + 卡钉板数量(`clip_count`)：`1`表示卡钉板数量为 1
2. 配置失败

```json
{
  "status": 1,
  "result": {
    "inst": 2,
    "id": ["37-32-48-5B", "37-32-4A-13"]
  }
}
```

+ 状态码 (`status`): `1` 表示操作失败
+ 数据 (`result`):
    - 指令类型 (`inst`): `4` 表示设备查询指令
    - 设备 ID (`id`): 设备信息，包含查询失败的设备 ID

# 数据帧
+ 字节序：小端在前
+ 帧格式

| Data | Type | Length | Description |
| --- | --- | --- | --- |
| Frame Delimiter | uint8_t[3] | 3 Byte | 固定值为 0xA5, 0xFF, 0xCC |
| Device ID | uint8_t[4] | 4 Byte | 四位发送设备 ID |
| Device Status | uint16_t | uint16_t | 两个字节的设备状态 |
| Data Type | uint8_t | 1 Byte | 数据类型 |
| Data Length | uint16_t | uint16_t | 数据长度 |
| Data Payload | uint8_t | Payload Size | 帧负载 |
| Checksum | uint8_t | uint8_t | 前面所有数据的奇偶校验值 |


+ 设备状态（Device Status）

| Data | Type | Length | Description |
| --- | --- | --- | --- |
| Color Sensor | Bit | 1 Bit | 0，颜色不匹配或无传感器<br/>1，颜色匹配 |
| Sleeve Limit | Bit | 1 Bit | 0，探针断开；<br/>1，探针导通 |
| Electromagnet Unlock Button | Bit | 1 Bit | 0，按钮未按下；<br/>1，按钮按下 |
| Battery Low Alarm | Bit | 1 Bit | 0，电池正常；<br/>1，电池低电量 |
| Pressure Sensor | Bit | 1 Bit | 0，气压传感器断开；1，气压传感器触发 |
| Electromagnetic Lock1 | Bit | 1 Bit | 0，电磁锁1未锁；<br/>1，电磁锁1上锁 |
| Electromagnetic Lock2 | Bit | 1 Bit | 0，电磁锁 2 未锁；<br/>1，电磁锁 2 上锁 |
| Accessory1 | Bit | 1 Bit | 0，辅件1不存在；<br/>1，辅件1存在 |
| Accessory2 | Bit | 1 Bit | 0，辅件 2 不存在；<br/>1，辅件 2 存在 |
| Reserved | Bit | 7 Bits | 保留字段 |


### 导通数据包
#### 包格式
| Data | Type | Length | Description |
| --- | --- | --- | --- |
| Conduction Length | uint16_t | 2 Byte | 导通数据长度 |
| Conduction Data | uint8_t | `Conduction Length` Byte | 导通数据 |


#### 存储方式
为了高效存储和传输导通数据，我们采用 `真值表`的形式表示针孔之间的连接状态，并通过 `位压缩` 技术减少数据量。以下是对导通数据存储和传输方式的详细说明：

##### 真值表结构
+ 行和列：真值表的行和列分别代表检测对象的针孔。
+ 矩阵大小：如果检测对象有 `N` 个针孔，则真值表为 `N × N` 的矩阵。
+ 交叉点值：
    - `1`：表示两个针孔之间有连接。
    - `0`：表示两个针孔之间无连接。

##### 示例
![画板](https://cdn.nlark.com/yuque/0/2024/jpeg/38593066/1734489409965-51c35d95-c937-46b5-80f1-54288502428a.jpeg)

假设检测对象有两个护套 A 和 B，每个护套有 2 个针孔，则：

+ 矩阵大小：`4 × 4`（护套 A 的 2 个针孔 + 护套 B 的 2 个针孔）。
+ 矩阵分区：
    - 前两列代表护套 A 的针孔。
    - 后两列代表护套 B 的针孔。

初始真值表（无连接）：

![image](https://cdn.nlark.com/yuque/__latex/b2ce7699f265a8a1f2bff274315869b8.svg)

如果连接情况为：

+ 护套 A 的针孔 1 —— 护套 B 的针孔 1
+ 护套 A 的针孔 2 —— 护套 B 的针孔 2

则真值表更新为：

![image](https://cdn.nlark.com/yuque/__latex/8c2ce7daf48549f69be1a6fa8e625532.svg)

#### 数据传输格式
为了减少数据传输量，真值表采用 位压缩 技术存储和传输。具体规则如下：

##### 位压缩
+ 将真值表中的每一行按顺序展开为二进制位。
+ 每 8 个二进制位压缩为 1 个字节（`uint8_t`）。
+ 如果数据不足 8 位，则填充 `0`。

##### 示例
以示例真值表为例：

![image](https://cdn.nlark.com/yuque/__latex/8c2ce7daf48549f69be1a6fa8e625532.svg)

+ 护套 A 数据：
    - 展开为二进制位：`1 0 0 1 1 0 0 1`
    - 位压缩后：`0x99`（十六进制）
+ 护套 B 数据：
    - 展开为二进制位：`1 0 0 1 1 0 0 1`
    - 位压缩后：`0x99`（十六进制）

##### 传输顺序
+ 按照 从左到右、从上到下 的顺序传输数据。
+ 每个护套的数据单独压缩和传输。

##### 传输结果
+ `Conduction Length`：`0x02`
+ `Conduction Data`：`0x99 0x99`

> ####  什么是位压缩？
> 位压缩是一种数据存储优化方法，将多个小数据紧密排列在字节（8 位）中，减少存储空间和传输数据量。例如，若每个数据只占 1 位，则 8 个数据可以存入 1 个字节，比直接使用 8 个字节存储每个数据（1 字节 1 位）要节省 87.5% 的空间。
>
> #### 为什么要使用位压缩？
> + 节省存储空间：减少无用的字节，提高存储效率。
> + 优化数据传输：减少无线传输数据量，提高通信效率。
> + 提高处理速度：减少读取和写入的数据量，提高数据操作效率。
>
> #### 位压缩的基本方法
> 假设有 10 位数据 `1001000101`，如果按 1 字节存 1 位，需要 10 字节，但用位压缩方法可以：
>
> 1. 前 8 位存入 1 个字节：`10010001` → `0x91`
> 2. 剩余 2 位放入新字节，并填充 6 个 0：`01 000000` → `0x40`  
最终存储 2 个字节，比直接存 10 个字节节省 80% 的空间！
>
> #### 解析（解压缩）方法
> + 读取字节数据
> + 按位提取有效数据，去掉填充位
> + 还原原始数据
>

### 阻值数据包
#### 包格式
| Data | Type | Length | Description |
| --- | --- | --- | --- |
| Resistance Length | uint8_t | 1 Byte | 阻值数据字段长度 |
| Resistance Data | uint8_t | `Resistance Length `Bytes | 阻值数据 |


#### 数据形式
在本系统中，需要将设备 **N 个 GPIO 采集到的阻值值** 传输给上位机或。由于阻值值范围在 **0~255** 之间，因此每个阻值值可以用 **1 个字节（uint8_t）** 存储和传输。  

1. 数据以 **紧凑的字节数组** 形式传输，格式如下：

```c
[Res_1] [Res_2] [Res_3] ... [Res_N]
```

其中：

+ **Res_i**（1 字节）：表示第 i 个 GPIO 采集到的阻值值（0~255）。
+ 数据总长度为 **N 字节**，N 取决于设备支持的 GPIO 数量。
2. 假设设备启用 **5 个 GPIO 阻值检测**，采集到的阻值值分别为：

```c
GPIO1 = 120, GPIO2 = 45, GPIO3 = 200, GPIO4 = 0, GPIO5 = 255
```

则发送的数据内容为：

```c
0x78 0x2D 0xC8 0x00 0xFF
```

则发送的阻值数据包为：

```c
0x05 0x78 0x2D 0xC8 0x00 0xFF
```

### 卡钉数据包
为了高效存储和传输卡钉板上 16 个 GPIO 的电平状态，我们采用 `uint16_t` 数据类型来表示每个卡钉板的 GPIO 状态。

#### 包格式
| Data | Type | Length | Description |
| --- | --- | --- | --- |
| Clip Num | uint8_t | 1 Byte | 卡钉板数量 |
| Clip Data | uint16_t | `Clip Num` × 2 Bytes | 卡钉数据 |


#### 存储方式
每个卡钉板的 16 个 GPIO 状态通过一个 `uint16_t`（16 位无符号整数）来表示。具体存储规则如下：

+ 位映射：
    - 每个 GPIO 的状态（`0` 或 `1`）映射到 `uint16_t` 的一个二进制位。
    - GPIO 0 对应最低位（第 0 位），GPIO 15 对应最高位（第 15 位）。
    - 例如：
        * GPIO 0 的状态为 `1` → 第 0 位为 `1`
        * GPIO 1 的状态为 `0` → 第 1 位为 `0`
        * GPIO 15 的状态为 `1` → 第 15 位为 `1`
+ 示例：

假设某个卡钉板的 GPIO 状态如下：

```plain
GPIO 0: 1
GPIO 1: 0
GPIO 2: 1
GPIO 3: 0
...
GPIO 14: 0
GPIO 15: 1
```

对应的 `uint16_t` 值为：

```plain
0b1010 0000 0000 0001 (二进制)
0xA001 (十六进制)
```

#### 数据传输格式
+ `Clip Num`：
    - 表示卡钉板的数量，占用 1 字节。
    - 例如，如果有 3 个卡钉板，则 `Clip Num` 的值为 `3`。
+ `Clip Data`：
    - 每个卡钉板的 GPIO 状态占用 2 字节（`uint16_t`）。
    - 如果有 `N` 个卡钉板，则 `Clip Data` 的总长度为 `N × 2` 字节。

例如，3 个卡钉板的 GPIO 状态分别为 `0xA001`、`0xB002`、`0xC003`，则 `Clip Data` 的值为：

```plain
01 A0 02 B0 03 C0  (十六进制)
```

#### 示例
假设系统中有 2 个卡钉板，其 GPIO 状态如下：

1. 卡钉板 1：

GPIO 状态：

```plain
GPIO 0: 1
GPIO 1: 0
GPIO 2: 1
GPIO 3: 0
GPIO 4: 0
GPIO 5: 0
GPIO 6: 0
GPIO 7: 0
GPIO 8: 0
GPIO 9: 0
GPIO 10: 0
GPIO 11: 0
GPIO 12: 0
GPIO 13: 0
GPIO 14: 0
GPIO 15: 1
```

`uint16_t` 值：

```plain
0b1010 0000 0000 0001 (二进制)
0xA001 (十六进制)
```

2. 卡钉板 2：

GPIO 状态：

```plain
GPIO 0: 0
GPIO 1: 1
GPIO 2: 0
GPIO 3: 1
GPIO 4: 0
GPIO 5: 0
GPIO 6: 0
GPIO 7: 0
GPIO 8: 0
GPIO 9: 0
GPIO 10: 0
GPIO 11: 0
GPIO 12: 0
GPIO 13: 0
GPIO 14: 0
GPIO 15: 0
```

`<font style="color:rgb(64, 64, 64);">uint16_t</font>`<font style="color:rgb(64, 64, 64);"> 值：</font>

```plain
0b0101 0000 0000 0000 (二进制)
0x5000 (十六进制)
```

3. 数据传输格式：
+ `Clip Num`：`0x02`（1 字节）
+ `Clip Data`：`0x01 0xA0 0x00 0x50`（4 字节）

# 通信时序图
![](https://cdn.nlark.com/yuque/__puml/7eea62d4347cad0f17701993051a817a.svg)

# 版本说明
| Version | Date | Description |
| --- | --- | --- |
| 1.0 | 20241103 | + 初次发布 |
| 1.1 | 20250218 | + 数据包中新增发送设备 ID<br/>+ 解锁指令新增全解锁指令 |
| v1.2 | 20250304 | + 删除了配置指令中的控制字段<br/>+ 删除了配置指令中的阻值索引<br/>+ 新增模式选择指令<br/>+ 新增设备控制指令<br/>+ 新增指令回复 data 字段<br/>+ 新增通信时序图<br/>+ 修正导通数据包<br/>+ 新增阻值数据包<br/>+ 新增卡钉数据包<br/>+ 新增指令文字说明<br/>+ 新增设备查询指令<br/>+ 修正卡钉数据描述 |


